<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Muze OS · Audit</title>
  <style>
    :root {
      --bg: #0b0d10;
      --panel: #12161c;
      --line: #232a33;
      --text: #eef2f7;
      --muted: #95a1b3;
      --accent: #26CCC0
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.45 Inter, system-ui
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px
    }

    .card {
      background: linear-gradient(180deg, #171c23, var(--panel));
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px
    }

    .tbl {
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 10px;
      margin-top: 10px
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      font-size: 12px
    }

    th {
      color: var(--muted)
    }

    a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700
    }

    .nav {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    .nav a.active {
      color: #d8fffc;
      text-decoration: underline;
      text-underline-offset: 3px
    }
  </style>
</head>

<body>
  <main class="wrap">
    <div class="top">
      <div style="display:flex;align-items:center;gap:12px">
        <svg viewBox="0 0 698 287" style="height:32px;width:auto;filter:drop-shadow(0 0 18px rgba(38,204,192,.22))"
          xmlns="http://www.w3.org/2000/svg" aria-label="Muze logo">
          <style>
            .s0 {
              fill: #fefefe
            }

            .s1 {
              fill: #ffffff
            }

            .s2 {
              fill: #26ccc0
            }
          </style>
          <g>
            <path class="s1"
              d="m23 48.5c0-14.8 11.7-26.5 26.5-26.5h5.8c11.3 0 19.2 5.8 24 13.7l64 104.1 64.2-104.4c1.8-2.8 5-7 10.3-10.3 10.7-6.7 21.9-5 25-4.4 4 1.7 9.8 5.1 12.6 11.3 4.6 10.3-1.7 22.6-5.7 28.7-44.4 67.4-76.7 116.1-83.5 127.8 0 0-6.7 11.6-15.7 14.6-3.9 1.3-7.9 1.3-7.9 1.3-9.7 0-16.5-5.1-22-13.4l-45.7-70.4v119.6c0 14.4-11.7 25.7-26.1 25.7-14.5 0-25.8-11.3-25.8-25.7z" />
            <path class="s2"
              d="m257 240.5c0-14-11.4-25.4-25.4-25.4-14 0-25.4 11.4-25.4 25.4 0 14.1 11.4 25.4 25.4 25.4 14 0 25.4-11.3 25.4-25.4z" />
          </g>
        </svg>
        <h1 style="margin:0;font-size:24px">Muze OS · Audit Trail</h1>
      </div>
      <div class="nav"><a class="link" href="/">Home</a> · <a class="link" href="/operations/">Operations</a> · <a
          class="link" href="/finances/">Finance</a> · <a class="link" href="/commercial/">Commercial</a> · <a
          class="link active" href="/audit/">Audit</a> · <a class="link" href="https://claw.muze.cl/live/"
          target="_blank" rel="noopener">Live Canvas ↗</a></div>
    </div>
    <div style="margin:6px 0 12px 0"></div>
    <div class="card" style="margin-bottom:10px">
      <div id="score" style="font-size:18px">Discipline score: -</div>
      <div id="meta" style="color:var(--muted)">Cargando…</div>
      <div id="consistency" style="color:var(--muted);margin-top:4px">Consistency: -</div>
    </div>
    <div class="card" style="margin-bottom:10px">
      <div style="font-size:16px;margin-bottom:6px">Role Discipline (AID/CFO/COO/CAO/CSO/COS)</div>
      <div class="tbl">
        <table>
          <thead>
            <tr>
              <th>Role</th>
              <th>Score</th>
              <th>Mut24h</th>
              <th>ACK on-time</th>
              <th>Errors</th>
              <th>Strict Mode</th>
            </tr>
          </thead>
          <tbody id="roleRows"></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <div class="tbl">
        <table>
          <thead>
            <tr>
              <th>ts</th>
              <th>type</th>
              <th>source</th>
              <th>entityId</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>
  <script>
    (async () => {
      const me = await fetch('/api/me'); if (!me.ok) { location.href = '/?next=/audit/'; return; }
      const [er, sr, cr, rr] = await Promise.all([
        fetch('/api/events', { cache: 'no-store' }),
        fetch('/api/discipline-score', { cache: 'no-store' }),
        fetch('/api/consistency-health', { cache: 'no-store' }),
        fetch('/api/role-discipline', { cache: 'no-store' })
      ]);
      const d = await er.json();
      const s = await sr.json();
      const c = await cr.json();
      const rd = await rr.json();
      const ev = d.events || [];
      score.textContent = `Discipline score (24h): ${s.score ?? '-'} / 100`;
      meta.textContent = `${ev.length} eventos recientes · mutaciones24h: ${s.counts?.mutations24h ?? 0}`;
      const bc = c.byChannel || {};
      const fmt = (k) => { const x = bc[k] || {}; return `${k}:${x.lagSec ?? '-'}s${x.ok60s ? '✅' : '⚠️'}` };
      consistency.textContent = `Consistency <60s: ${c.consistencyOk ? 'OK ✅' : 'BREACH ⚠️'} · ${fmt('dm')} · ${fmt('consulting')} · ${fmt('roadmap')} · ${fmt('system')}`;

      const roles = rd.roles || {};
      roleRows.innerHTML = '';
      ['AID', 'CFO', 'COO', 'CAO', 'CSO', 'COS'].forEach(r => {
        const x = roles[r] || { score: '-', mutations24h: 0, ackOnTime24h: 0, ackRequired24h: 0, error24h: 0, strictMode: false };
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r}</td><td>${x.score}</td><td>${x.mutations24h || 0}</td><td>${x.ackOnTime24h || 0}/${x.ackRequired24h || 0}</td><td>${x.error24h || 0}</td><td>${x.strictMode ? 'ON ⚠️' : 'OFF ✅'}</td>`;
        roleRows.appendChild(tr);
      });

      rows.innerHTML = ''; ev.slice().reverse().forEach(e => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${e.ts || ''}</td><td>${e.type || ''}</td><td>${e.source || ''}</td><td>${e.entityId || ''}</td>`; rows.appendChild(tr); });
    })();
  </script>
</body>

</html>