<!doctype html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Muze OS Â· Control Tower</title>
<style>
:root{--bg:#0b0d10;--panel:#12161c;--panel2:#171c23;--line:#232a33;--text:#eef2f7;--muted:#95a1b3;--accent:#26CCC0}
*{box-sizing:border-box}body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,rgba(38,204,192,.12),transparent 40%),var(--bg);color:var(--text);font:14px/1.45 Inter,system-ui}
.wrap{max-width:1100px;margin:0 auto;padding:22px}.top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.card{background:linear-gradient(180deg,var(--panel2),var(--panel));border:1px solid var(--line);border-radius:14px;padding:14px}
.grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:12px}.k{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}.v{font-size:24px;font-weight:700;margin-top:6px}
a{color:var(--accent);text-decoration:none;font-weight:700}.muted{color:var(--muted)}.nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center}.nav a.active{color:#d8fffc;text-decoration:underline;text-underline-offset:3px}
.mods{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:12px}
#auth{position:fixed;inset:0;background:rgba(0,0,0,.64);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:99}
#auth .panel{width:360px;background:linear-gradient(180deg,var(--panel2),var(--panel));border:1px solid #2a313c;border-radius:14px;padding:16px;display:grid;gap:10px}
input,button{width:100%;padding:10px 11px;border-radius:10px;border:1px solid #2a313c;background:#0f1319;color:var(--text)}button{background:var(--accent);color:#052524;border:none;font-weight:700;cursor:pointer}
small{color:var(--muted)}
@media(max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}.mods{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="auth"><div class="panel"><b>Login Â· Muze OS</b><input id="u" placeholder="usuario"/><input id="p" placeholder="password" type="password"/><button id="loginBtn">Entrar</button><small id="authMsg"></small></div></div>
<main class="wrap">
  <div class="top">
    <div style="display:flex;align-items:center;gap:12px">
      <svg viewBox="0 0 698 287" style="height:32px;width:auto;filter:drop-shadow(0 0 18px rgba(38,204,192,.22))" xmlns="http://www.w3.org/2000/svg" aria-label="Muze logo"><style>.s0{fill:#fefefe}.s1{fill:#ffffff}.s2{fill:#26ccc0}</style><g><path class="s1" d="m23 48.5c0-14.8 11.7-26.5 26.5-26.5h5.8c11.3 0 19.2 5.8 24 13.7l64 104.1 64.2-104.4c1.8-2.8 5-7 10.3-10.3 10.7-6.7 21.9-5 25-4.4 4 1.7 9.8 5.1 12.6 11.3 4.6 10.3-1.7 22.6-5.7 28.7-44.4 67.4-76.7 116.1-83.5 127.8 0 0-6.7 11.6-15.7 14.6-3.9 1.3-7.9 1.3-7.9 1.3-9.7 0-16.5-5.1-22-13.4l-45.7-70.4v119.6c0 14.4-11.7 25.7-26.1 25.7-14.5 0-25.8-11.3-25.8-25.7z"/><path class="s2" d="m257 240.5c0-14-11.4-25.4-25.4-25.4-14 0-25.4 11.4-25.4 25.4 0 14.1 11.4 25.4 25.4 25.4 14 0 25.4-11.3 25.4-25.4z"/></g></svg>
      <h1 style="margin:0;font-size:24px">Muze OS Â· Control Tower</h1>
    </div>
    <div class="nav"><a class="active" href="/">Home</a> Â· <a href="/operations/">Operations</a> Â· <a href="/finances/">Finance</a> Â· <a href="/commercial/">Commercial</a> Â· <a href="/audit/">Audit</a> Â· <a href="https://claw.muze.cl/live/" target="_blank" rel="noopener">Live Canvas â†—</a></div>
  </div>
  <div style="margin-bottom:14px"><small class="muted" id="who">-</small></div>

  <section class="grid">
    <div class="card"><div class="k">Open Tasks</div><div id="openN" class="v">-</div></div>
    <div class="card"><div class="k">In Progress</div><div id="progN" class="v">-</div></div>
    <div class="card"><div class="k">Blocked</div><div id="blockN" class="v">-</div></div>
    <div class="card"><div class="k">Facturado Neto (Cermaq)</div><div id="netRevenue" class="v">-</div></div>
    <div class="card"><div class="k">Sync Health</div><div id="syncHealth" class="v" style="font-size:16px">-</div></div>
  </section>

  <section class="mods">
    <div class="card">
      <h3 style="margin:0 0 8px 0">Execution</h3>
      <div class="muted">Tareas, owners, deadlines, bloqueos, seguimiento.</div>
      <div style="margin-top:8px"><a href="/operations/">Abrir mÃ³dulo</a></div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px 0">Finance</h3>
      <div class="muted">Ingresos, IVA, costos, gastos, utilidad e impuesto estimado.</div>
      <div style="margin-top:8px"><a href="/finances/">Abrir mÃ³dulo</a></div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px 0">Commercial</h3>
      <div class="muted">Pipeline comercial, cotizaciones y actividad de cierre.</div>
      <div style="margin-top:8px"><a href="/commercial/">Abrir mÃ³dulo</a></div>
    </div>
  </section>
</main>
<script>
const CLP=n=>new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}).format(Number(n||0));
const params=new URLSearchParams(location.search); const next=params.get('next')||'';

async function getFinance(){
  try{
    const r=await fetch('/api/finance-summary',{cache:'no-store'});
    if(r.ok) return await r.json();
  }catch{}
  try{
    const f=await fetch('/finance_fallback.json',{cache:'no-store'});
    const d=await f.json();
    const rev=(d.revenues||[]).reduce((a,x)=>a+Number(x.net||0),0);
    return { netRevenue: rev };
  }catch{}
  return { netRevenue:0 };
}

async function loadOS(){
  const me=await fetch('/api/me');
  if(!me.ok){ document.getElementById('auth').style.display='flex'; return; }
  const meJ=await me.json();
  document.getElementById('auth').style.display='none';
  who.textContent=`${meJ.user.name} (${meJ.user.role})`;

  const td=await (await fetch('/api/tasks',{cache:'no-store'})).json();
  const tasks=td.tasks||[];
  const counts={todo:0,in_progress:0,blocked:0,done:0};
  tasks.forEach(t=>counts[t.status]=(counts[t.status]||0)+1);
  openN.textContent=(counts.todo||0)+(counts.in_progress||0)+(counts.blocked||0);
  progN.textContent=counts.in_progress||0;
  blockN.textContent=counts.blocked||0;

  const os=await (await fetch('/api/os-summary',{cache:'no-store'})).json();
  syncHealth.textContent = os.health==='ok'
    ? `ðŸŸ¢ OK Â· lag ${os.lagSec??'-'}s (â‰¤5m)`
    : (os.health==='degraded'
      ? `ðŸŸ¡ Degraded Â· lag ${os.lagSec??'-'}s (5â€“30m)`
      : (os.health==='idle'
        ? `ðŸ”µ Idle Â· lag ${os.lagSec??'-'}s (>30m sin actividad)`
        : `ðŸ”´ Warn Â· sin eventos`));

  const f=await getFinance();
  netRevenue.textContent=CLP(f.netRevenue||0);

  if(next){ location.href=next; }
}

loginBtn.onclick=async()=>{
  authMsg.textContent='Entrando...';
  const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u.value,password:p.value})});
  if(!r.ok){authMsg.textContent='Credenciales invÃ¡lidas'; return;}
  authMsg.textContent='OK';
  loadOS();
};

loadOS();
</script>
</body>
</html>
