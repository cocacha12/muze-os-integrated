<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Muze OS · Operations</title>
  <style>
    :root {
      --bg: #0b0d10;
      --panel: #12161c;
      --panel2: #171c23;
      --line: #232a33;
      --text: #eef2f7;
      --muted: #95a1b3;
      --accent: #26CCC0
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(38, 204, 192, .12), transparent 40%), var(--bg);
      color: var(--text);
      font: 14px/1.4 Inter, ui-sans-serif, system-ui
    }

    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px
    }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 14px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .brand img {
      height: 30px;
      width: auto;
      filter: drop-shadow(0 0 18px rgba(38, 204, 192, .22))
    }

    .brand h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: .2px
    }

    .meta {
      color: var(--muted);
      font-size: 12px
    }

    .link {
      color: var(--accent);
      text-decoration: none
    }

    .nav {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    .nav a.active {
      color: #d8fffc;
      text-decoration: underline;
      text-underline-offset: 3px
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 14px
    }

    .card {
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .25)
    }

    .k {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em
    }

    .v {
      font-size: 28px;
      font-weight: 700;
      margin-top: 6px
    }

    .board {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      align-items: start
    }

    .col {
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--line);
      border-radius: 14px;
      height: 62vh;
      min-height: 320px;
      max-height: 760px;
      overflow: hidden;
      display: flex;
      flex-direction: column
    }

    .col h3 {
      margin: 0;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      flex: 0 0 auto
    }

    .list {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      flex: 1 1 auto;
      min-height: 0
    }

    .task {
      border: 1px solid #2a313c;
      border-radius: 12px;
      padding: 12px;
      background: #0f1319
    }

    .id {
      font-size: 12px;
      color: var(--accent);
      margin-bottom: 4px;
      font-weight: 700;
      letter-spacing: .02em
    }

    .t {
      font-size: 15px;
      line-height: 1.35;
      font-weight: 650
    }

    .m {
      font-size: 13px;
      line-height: 1.5;
      color: #d4dce7;
      margin-top: 6px
    }

    .note {
      margin-top: 14px;
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      color: var(--muted)
    }

    #auth {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .64);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99
    }

    #auth .panel {
      width: 360px;
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid #2a313c;
      border-radius: 14px;
      padding: 16px;
      display: grid;
      gap: 10px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, .45)
    }

    #auth b {
      font-size: 16px
    }

    input,
    button {
      width: 100%;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid #2a313c;
      background: #0f1319;
      color: var(--text)
    }

    button {
      background: var(--accent);
      color: #052524;
      border: none;
      font-weight: 700;
      cursor: pointer
    }

    small {
      color: var(--muted)
    }

    @media(max-width:1060px) {

      .grid,
      .board {
        grid-template-columns: repeat(2, minmax(0, 1fr))
      }
    }

    @media(max-width:760px) {
      .wrap {
        padding: 14px
      }

      .brand h1 {
        font-size: 18px
      }

      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px
      }

      .v {
        font-size: 22px
      }

      .board {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        padding-bottom: 6px
      }

      .col {
        min-width: 86vw;
        scroll-snap-align: start;
        min-height: 220px;
        height: 58vh
      }

      .col h3 {
        font-size: 11px;
        padding: 10px
      }

      .list {
        padding: 8px
      }
    }

    @media(max-width:520px) {
      .grid {
        grid-template-columns: 1fr 1fr
      }

      .task {
        padding: 12px
      }

      .id {
        font-size: 12px
      }

      .t {
        font-size: 16px
      }

      .m {
        font-size: 14px;
        line-height: 1.52
      }

      #taskPicker,
      #ownerFilter {
        max-width: 100% !important;
        width: 100%
      }
    }
  </style>
</head>

<body>
  <div id="auth">
    <div class="panel"><b>Login · Muze PM</b><input id="u" placeholder="usuario" /><input id="p" placeholder="password"
        type="password" /><button id="loginBtn">Entrar</button><small id="authMsg"></small></div>
  </div>
  <div class="wrap">
    <div class="top">
      <div style="display:flex;align-items:center;gap:12px">
        <svg viewBox="0 0 698 287" style="height:32px;width:auto;filter:drop-shadow(0 0 18px rgba(38,204,192,.22))"
          xmlns="http://www.w3.org/2000/svg" aria-label="Muze logo">
          <style>
            .s0 {
              fill: #fefefe
            }

            .s1 {
              fill: #ffffff
            }

            .s2 {
              fill: #26ccc0
            }
          </style>
          <g>
            <path class="s1"
              d="m23 48.5c0-14.8 11.7-26.5 26.5-26.5h5.8c11.3 0 19.2 5.8 24 13.7l64 104.1 64.2-104.4c1.8-2.8 5-7 10.3-10.3 10.7-6.7 21.9-5 25-4.4 4 1.7 9.8 5.1 12.6 11.3 4.6 10.3-1.7 22.6-5.7 28.7-44.4 67.4-76.7 116.1-83.5 127.8 0 0-6.7 11.6-15.7 14.6-3.9 1.3-7.9 1.3-7.9 1.3-9.7 0-16.5-5.1-22-13.4l-45.7-70.4v119.6c0 14.4-11.7 25.7-26.1 25.7-14.5 0-25.8-11.3-25.8-25.7z" />
            <path class="s2"
              d="m257 240.5c0-14-11.4-25.4-25.4-25.4-14 0-25.4 11.4-25.4 25.4 0 14.1 11.4 25.4 25.4 25.4 14 0 25.4-11.3 25.4-25.4z" />
          </g>
        </svg>
        <h1 style="margin:0;font-size:24px">Muze OS · Operations</h1>
      </div>
      <div class="nav"><a class="link" href="/">Home</a> · <a class="link active" href="/operations/">Operations</a> ·
        <a class="link" href="/finances/">Finance</a> · <a class="link" href="/commercial/">Commercial</a> · <a
          class="link" href="/audit/">Audit</a> · <a class="link" href="https://claw.muze.cl/live/" target="_blank"
          rel="noopener">Live Canvas ↗</a></div>
    </div>
    <div style="margin-bottom:14px"><small class="meta" id="who">-</small></div>

    <div class="card" style="margin-bottom:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <span class="k" style="margin:0">Filtro responsable</span>
      <select id="ownerFilter"
        style="max-width:280px;background:#0f1319;color:#fff;border:1px solid #2a313c;border-radius:10px;padding:8px 10px">
        <option value="">Todos</option>
      </select>
      <button id="clearOwnerFilter"
        style="background:#0f1319;color:#fff;border:1px solid #2a313c;border-radius:10px;padding:8px 10px;cursor:pointer">Limpiar
        filtro</button>
      <small id="filterState" style="color:#95a1b3"></small>
    </div>

    <div class="grid">
      <div class="card">
        <div class="k">To Do</div>
        <div id="n_todo" class="v">0</div>
      </div>
      <div class="card">
        <div class="k">In Progress</div>
        <div id="n_prog" class="v">0</div>
      </div>
      <div class="card">
        <div class="k">Blocked</div>
        <div id="n_block" class="v">0</div>
      </div>
      <div class="card">
        <div class="k">Done</div>
        <div id="n_done" class="v">0</div>
      </div>
    </div>

    <div class="board">
      <div class="col">
        <h3>To Do</h3>
        <div id="todo" class="list"></div>
      </div>
      <div class="col">
        <h3>In Progress</h3>
        <div id="in_progress" class="list"></div>
      </div>
      <div class="col">
        <h3>Blocked</h3>
        <div id="blocked" class="list"></div>
      </div>
      <div class="col">
        <h3>Done</h3>
        <div id="done" class="list"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="k" style="margin-bottom:8px">Timeline por tarea</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
        <select id="taskPicker"
          style="max-width:520px;background:#0f1319;color:#fff;border:1px solid #2a313c;border-radius:10px;padding:8px 10px">
          <option value="">Selecciona tarea…</option>
        </select>
        <small id="tlMeta">Notas operativas: compromisos, bloqueos, evidencia.</small>
      </div>
      <div id="timeline" class="list"></div>
    </div>

    <div class="note">Modo lectura: los cambios se solicitan por chat de Gerencia. Esta app muestra estado oficial
      sincronizado.</div>
  </div>

  <script>
    let __tasks = [];
    const whoEl = document.getElementById('who');
    const nTodoEl = document.getElementById('n_todo');
    const nProgEl = document.getElementById('n_prog');
    const nBlockEl = document.getElementById('n_block');
    const nDoneEl = document.getElementById('n_done');
    const ownerFilterEl = document.getElementById('ownerFilter');
    const clearOwnerFilterEl = document.getElementById('clearOwnerFilter');
    const filterStateEl = document.getElementById('filterState');
    const taskPickerEl = document.getElementById('taskPicker');
    const timelineEl = document.getElementById('timeline');
    const tlMetaEl = document.getElementById('tlMeta');
    const loginBtnEl = document.getElementById('loginBtn');
    const authMsgEl = document.getElementById('authMsg');
    const userEl = document.getElementById('u');
    const passEl = document.getElementById('p');
    async function load(taskId) {
      try {
        const me = await fetch('/api/me');
        if (!me.ok) { location.href = '/?next=/operations/'; return; }
        const mej = await me.json();
        whoEl.innerHTML = `${mej.user.name} (${mej.user.role}) · <a class='link' href='/operations/executive.html'>Executive</a> · <a class='link' href='#' id='logoutL'>Salir</a>`;
        setTimeout(() => { const l = document.getElementById('logoutL'); if (l) l.onclick = async (e) => { e.preventDefault(); await fetch('/api/logout', { method: 'POST' }); location.reload(); }; }, 0);

        document.getElementById('auth').style.display = 'none';
        const td = await (await fetch('/api/tasks', { cache: 'no-store' })).json();
        __tasks = (td.tasks || []);
        const counts = { todo: 0, in_progress: 0, blocked: 0, done: 0 };
        __tasks.forEach(t => counts[t.status] = (counts[t.status] || 0) + 1);
        nTodoEl.textContent = counts.todo || 0; nProgEl.textContent = counts.in_progress || 0; nBlockEl.textContent = counts.blocked || 0; nDoneEl.textContent = counts.done || 0;
        ['todo', 'in_progress', 'blocked', 'done'].forEach(k => document.getElementById(k).innerHTML = '');
        const owners = [...new Set(__tasks.map(t => t.ownerId || '-'))].sort();
        ownerFilterEl.innerHTML = '<option value="">Todos</option>' + owners.map(o => `<option value="${o}">${o}</option>`).join('');
        const sel = ownerFilterEl.dataset.sel || ''; if (sel) ownerFilterEl.value = sel;

        let filtered = __tasks.filter(t => !ownerFilterEl.value || (t.ownerId || '-') === ownerFilterEl.value);
        if (filtered.length === 0 && __tasks.length > 0 && ownerFilterEl.value) {
          ownerFilterEl.value = '';
          ownerFilterEl.dataset.sel = '';
          filtered = __tasks.slice();
        }
        filterStateEl.textContent = ownerFilterEl.value ? `Filtro activo: ${ownerFilterEl.value} (${filtered.length}/${__tasks.length})` : `Mostrando todas (${__tasks.length})`;
        filtered.forEach(t => {
          const el = document.createElement('div'); el.className = 'task';
          el.innerHTML = `<div class='id'>${t.id}</div><div class='t'>${t.title}</div><div class='m'>Owner: ${t.ownerId || '-'} · Due: ${t.dueDate || '-'}</div><div class='m'>Priority: ${t.priority}</div>`;
          el.style.cursor = 'pointer';
          el.onclick = () => showTimeline(t.id);
          const col = document.getElementById(t.status || 'todo') || document.getElementById('todo');
          if (col) col.appendChild(el);
        });

        taskPickerEl.innerHTML = '<option value="">Selecciona tarea…</option>' + filtered.map(t => `<option value="${t.id}">${t.id} · ${t.title}</option>`).join('');
        if (taskId) taskPickerEl.value = taskId;
        if (taskPickerEl.value) await showTimeline(taskPickerEl.value);
      } catch (err) {
        console.error('LOAD_ERROR', err);
        filterStateEl.textContent = 'Error cargando tablero. Reintentando...';
      }
    }

    async function showTimeline(taskId) {
      if (!taskId) { timelineEl.innerHTML = ''; return; }
      const r = await fetch(`/api/tasks/${encodeURIComponent(taskId)}/notes`);
      if (!r.ok) { timelineEl.innerHTML = '<small>Sin acceso al timeline</small>'; return; }
      const j = await r.json();
      tlMetaEl.textContent = `${j.notes.length} eventos en ${taskId}`;
      timelineEl.innerHTML = '';
      if (!j.notes.length) { timelineEl.innerHTML = '<small>Sin notas aún.</small>'; return; }
      j.notes.forEach(n => {
        const el = document.createElement('div'); el.className = 'task';
        const badge = n.type ? `[${n.type.toUpperCase()}]` : '[UPDATE]';
        el.innerHTML = `<div class='id'>${badge} · ${n.ts}</div><div class='t'>${n.actorName || n.actorId || 'system'}</div><div class='m'>${n.text || ''}</div>${n.nextCheckDate ? `<div class='m'>Próximo control: ${n.nextCheckDate}</div>` : ''}`;
        timelineEl.appendChild(el);
      });
    }
    ownerFilterEl.onchange = () => { ownerFilterEl.dataset.sel = ownerFilterEl.value; load(taskPickerEl.value); };
    clearOwnerFilterEl.onclick = () => { ownerFilterEl.value = ''; ownerFilterEl.dataset.sel = ''; load(taskPickerEl.value); };
    taskPickerEl.onchange = () => showTimeline(taskPickerEl.value);
    loginBtnEl.onclick = async () => {
      authMsgEl.textContent = 'Entrando...';
      const r = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: userEl.value, password: passEl.value }) });
      if (!r.ok) { authMsgEl.textContent = 'Credenciales inválidas'; return; }
      authMsgEl.textContent = 'OK';
      load();
    };
    load();
    setInterval(() => {
      if (document.getElementById('auth').style.display === 'none') load(taskPickerEl.value);
    }, 15000);
  </script>
</body>

</html>