<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Muze OS Â· Finance</title>
  <style>
    :root {
      --bg: #0b0d10;
      --panel: #12161c;
      --panel2: #171c23;
      --line: #232a33;
      --text: #eef2f7;
      --muted: #95a1b3;
      --accent: #26CCC0
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(38, 204, 192, .12), transparent 40%), var(--bg);
      color: var(--text);
      font: 14px/1.45 Inter, ui-sans-serif, system-ui
    }

    .wrap {
      max-width: 1240px;
      margin: 0 auto;
      padding: 20px
    }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px
    }

    .card {
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin: 12px 0
    }

    .k {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em
    }

    .v {
      font-size: 24px;
      font-weight: 700;
      margin-top: 6px
    }

    .tbl {
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 12px
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      padding: 9px 10px;
      border-bottom: 1px solid var(--line);
      text-align: left;
      font-size: 13px
    }

    th {
      color: var(--muted)
    }

    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border: 1px solid rgba(38, 204, 192, .4);
      border-radius: 999px;
      color: #d8fffc
    }

    .warn {
      color: #fbbf24
    }

    .ok {
      color: #86efac
    }

    #auth {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .64);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99
    }

    #auth .panel {
      width: 360px;
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid #2a313c;
      border-radius: 14px;
      padding: 16px;
      display: grid;
      gap: 10px
    }

    input,
    button {
      width: 100%;
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid #2a313c;
      background: #0f1319;
      color: var(--text)
    }

    button {
      background: var(--accent);
      color: #052524;
      border: none;
      font-weight: 700;
      cursor: pointer
    }

    small {
      color: var(--muted)
    }

    a {
      color: var(--accent);
      text-decoration: none
    }

    .nav {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    .nav a.active {
      color: #d8fffc;
      text-decoration: underline;
      text-underline-offset: 3px
    }

    @media(max-width:900px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr))
      }
    }
  </style>
</head>

<body>
  <div id="auth">
    <div class="panel"><b>Login Â· Muze PM</b><input id="u" placeholder="usuario" /><input id="p" placeholder="password"
        type="password" /><button id="loginBtn">Entrar</button><small id="authMsg"></small></div>
  </div>
  <main class="wrap">
    <div class="top">
      <div style="display:flex;align-items:center;gap:12px">
        <svg viewBox="0 0 698 287" style="height:32px;width:auto;filter:drop-shadow(0 0 18px rgba(38,204,192,.22))"
          xmlns="http://www.w3.org/2000/svg" aria-label="Muze logo">
          <style>
            .s0 {
              fill: #fefefe
            }

            .s1 {
              fill: #ffffff
            }

            .s2 {
              fill: #26ccc0
            }
          </style>
          <g>
            <path class="s1"
              d="m23 48.5c0-14.8 11.7-26.5 26.5-26.5h5.8c11.3 0 19.2 5.8 24 13.7l64 104.1 64.2-104.4c1.8-2.8 5-7 10.3-10.3 10.7-6.7 21.9-5 25-4.4 4 1.7 9.8 5.1 12.6 11.3 4.6 10.3-1.7 22.6-5.7 28.7-44.4 67.4-76.7 116.1-83.5 127.8 0 0-6.7 11.6-15.7 14.6-3.9 1.3-7.9 1.3-7.9 1.3-9.7 0-16.5-5.1-22-13.4l-45.7-70.4v119.6c0 14.4-11.7 25.7-26.1 25.7-14.5 0-25.8-11.3-25.8-25.7z" />
            <path class="s2"
              d="m257 240.5c0-14-11.4-25.4-25.4-25.4-14 0-25.4 11.4-25.4 25.4 0 14.1 11.4 25.4 25.4 25.4 14 0 25.4-11.3 25.4-25.4z" />
          </g>
        </svg>
        <h1 style="margin:0;font-size:24px">Muze OS Â· Finance (Cermaq)</h1>
      </div>
      <div class="nav"><a class="link" href="/">Home</a> Â· <a class="link" href="/operations/">Operations</a> Â· <a
          class="link active" href="/finances/">Finance</a> Â· <a class="link" href="/commercial/">Commercial</a> Â· <a
          class="link" href="/audit/">Audit</a> Â· <a class="link" href="https://claw.muze.cl/live/" target="_blank"
          rel="noopener">Live Canvas â†—</a></div>
    </div>

    <div class="card" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
      <span class="badge" id="scopeBadge">scope</span>
      <small id="regimeText"></small>
    </div>

    <section class="grid">
      <div class="card">
        <div class="k">Facturado Neto</div>
        <div id="netRevenue" class="v">-</div>
      </div>
      <div class="card">
        <div class="k">IVA DÃ©bito</div>
        <div id="ivaDebito" class="v">-</div>
      </div>
      <div class="card">
        <div class="k">IVA a Pagar Estimado</div>
        <div id="ivaPagar" class="v warn">-</div>
      </div>
      <div class="card">
        <div class="k">Utilidad Mensual Estimada</div>
        <div id="utilidadMes" class="v">-</div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <div class="k">Costos directos</div>
        <div id="costosDirectos" class="v">-</div>
      </div>
      <div class="card">
        <div class="k">Gastos operativos</div>
        <div id="gastosOpex" class="v">-</div>
      </div>
      <div class="card">
        <div class="k">Honorarios</div>
        <div id="honorarios" class="v">-</div>
      </div>
      <div class="card">
        <div class="k">Bonos extraordinarios</div>
        <div id="bonosExtra" class="v">-</div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <div class="k">Reserva impuesto mensual</div>
        <div id="reservaImpMensual" class="v">-</div>
      </div>
      <div class="card">
        <div class="k">Impuesto anual (estimado)</div>
        <div id="impuestoAnual" class="v">-</div>
      </div>
      <div class="card">
        <div class="k">Caja estimada fin de mes</div>
        <div id="cajaFinMes" class="v">-</div>
      </div>
      <div class="card">
        <div class="k">SemÃ¡foro caja</div>
        <div id="cajaHealth" class="v">-</div>
      </div>
      <div class="card">
        <div class="k">Margen neto estimado</div>
        <div id="margen" class="v">-</div>
      </div>
    </section>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Ingresos considerados (solo Cermaq)</h3>
      <div class="tbl">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Neto</th>
              <th>IVA</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="revRows"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Costos directos (detalle)</h3>
      <div class="tbl">
        <table>
          <thead>
            <tr>
              <th>Concepto</th>
              <th>Monto mensual</th>
              <th>Notas</th>
            </tr>
          </thead>
          <tbody id="costRows"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Gastos operativos (detalle)</h3>
      <div class="tbl">
        <table>
          <thead>
            <tr>
              <th>Concepto</th>
              <th>Monto mensual</th>
              <th>Notas</th>
            </tr>
          </thead>
          <tbody id="opexRows"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Honorarios (detalle)</h3>
      <div class="tbl">
        <table>
          <thead>
            <tr>
              <th>Concepto</th>
              <th>Monto mensual</th>
              <th>Notas</th>
            </tr>
          </thead>
          <tbody id="honRows"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Bonos extraordinarios</h3>
      <div class="tbl">
        <table>
          <thead>
            <tr>
              <th>Beneficiario</th>
              <th>Mes</th>
              <th>Monto</th>
              <th>Tipo</th>
              <th>Notas</th>
            </tr>
          </thead>
          <tbody id="bonusRows"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Resumen por proyecto</h3>
      <div class="tbl">
        <table>
          <thead>
            <tr>
              <th>Proyecto</th>
              <th>Neto</th>
              <th>IVA</th>
              <th>Total</th>
              <th>Costo directo</th>
              <th>ContribuciÃ³n bruta</th>
            </tr>
          </thead>
          <tbody id="projRows"></tbody>
        </table>
      </div>
    </div>

    <p class="warn">Nota: estimaciÃ³n de impuesto anual = run-rate mensual x 12 bajo rÃ©gimen Pro Pyme General (14D), Ãºtil
      para gestiÃ³n interna; validar cierre con contador.</p>
  </main>
  <script>
    const CLP = n => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 }).format(Number(n || 0));

    function computeFromFallback(d) {
      const revenues = d.revenues || [];
      const netRevenue = revenues.reduce((a, x) => a + Number(x.net || 0), 0);
      const ivaDebito = revenues.reduce((a, x) => a + Number(x.iva || 0), 0);
      const ivaCredito = Number(d.ivaCreditoEstimado || 0);
      const ivaPorPagarEstimado = Math.max(0, ivaDebito - ivaCredito);
      const totalCostosDirectos = (d.costsDirect || []).reduce((a, x) => a + Number(x.monthlyAmount || 0), 0);
      const totalGastosOperativos = (d.operatingExpenses || []).reduce((a, x) => a + Number(x.monthlyAmount || 0), 0);
      const totalHonorarios = (d.honorarios || []).reduce((a, x) => a + Number(x.monthlyAmount || 0), 0);
      const totalBonosExtraordinarios = (d.bonosExtraordinarios || []).reduce((a, x) => a + Number(x.amount || 0), 0);
      const utilidadMensualAntesImpuesto = netRevenue - totalCostosDirectos - totalGastosOperativos - totalHonorarios - totalBonosExtraordinarios;
      const idpcRate = Number(d.idpcRate || 0.25);
      const reservaImpuestoMensual = Math.max(0, utilidadMensualAntesImpuesto * idpcRate);
      const utilidadMensualEstimada = utilidadMensualAntesImpuesto - reservaImpuestoMensual;
      const impuestoAnualEstimado = Math.max(0, utilidadMensualAntesImpuesto * 12 * idpcRate);
      const margenNetoPct = netRevenue > 0 ? (utilidadMensualEstimada / netRevenue) * 100 : 0;
      const openingBalance = Number(d.openingBalance || 0);
      const minimumTarget = Number(d.minimumTarget || 3000000);
      const cajaEstimadaFinMes = openingBalance + utilidadMensualEstimada - ivaPorPagarEstimado;
      const health = cajaEstimadaFinMes >= minimumTarget ? 'green' : (cajaEstimadaFinMes >= minimumTarget * 0.7 ? 'yellow' : 'red');
      const by = {};
      revenues.forEach(r => { const k = r.project || 'Sin proyecto'; if (!by[k]) by[k] = { project: k, net: 0, iva: 0, total: 0, directCost: 0 }; by[k].net += Number(r.net || 0); by[k].iva += Number(r.iva || 0); by[k].total += Number(r.total || 0) });
      (d.costsDirect || []).forEach(c => { const k = c.project || 'Sin proyecto'; if (!by[k]) by[k] = { project: k, net: 0, iva: 0, total: 0, directCost: 0 }; by[k].directCost += Number(c.monthlyAmount || 0) });
      return { ...d, netRevenue, ivaDebito, ivaPorPagarEstimado, totalCostosDirectos, totalGastosOperativos, totalHonorarios, totalBonosExtraordinarios, utilidadMensualAntesImpuesto, reservaImpuestoMensual, utilidadMensualEstimada, impuestoAnualEstimado, margenNetoPct, openingBalance, minimumTarget, cajaEstimadaFinMes, health, byProject: Object.values(by) };
    }

    async function loadData() {
      const me = await fetch('/api/me');
      if (!me.ok) { location.href = '/?next=/finances/'; return; }
      document.getElementById('auth').style.display = 'none';
      let d = null;
      try {
        const r = await fetch('/api/finance-summary', { cache: 'no-store' });
        if (r.ok) d = await r.json();
      } catch { }
      if (!d) {
        const fb = await fetch('/finance_fallback.json', { cache: 'no-store' });
        const raw = await fb.json();
        d = computeFromFallback(raw);
      }

      scopeBadge.textContent = `Scope: ${d.scope}`;
      regimeText.textContent = `${d.regime} Â· Tasa IDPC ${Math.round(d.idpcRate * 100)}%`;

      netRevenue.textContent = CLP(d.netRevenue);
      ivaDebito.textContent = CLP(d.ivaDebito);
      ivaPagar.textContent = CLP(d.ivaPorPagarEstimado);
      costosDirectos.textContent = CLP(d.totalCostosDirectos);
      gastosOpex.textContent = CLP(d.totalGastosOperativos);
      honorarios.textContent = CLP(d.totalHonorarios || 0);
      bonosExtra.textContent = CLP(d.totalBonosExtraordinarios || 0);
      utilidadMes.textContent = CLP(d.utilidadMensualEstimada);
      reservaImpMensual.textContent = CLP(d.reservaImpuestoMensual || 0);
      impuestoAnual.textContent = CLP(d.impuestoAnualEstimado);
      cajaFinMes.textContent = CLP(d.cajaEstimadaFinMes || 0);
      cajaHealth.textContent = d.health === 'green' ? 'ðŸŸ¢ OK' : (d.health === 'yellow' ? 'ðŸŸ¡ Ajustar' : 'ðŸ”´ Riesgo');
      margen.textContent = `${(d.margenNetoPct || 0).toFixed(1)}%`;

      revRows.innerHTML = '';
      d.revenues.forEach(x => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.id}</td><td>${x.issueDate}</td><td>${x.customer}</td><td>${CLP(x.net)}</td><td>${CLP(x.iva)}</td><td>${CLP(x.total)}</td>`;
        revRows.appendChild(tr);
      });
      costRows.innerHTML = '';
      d.costsDirect.forEach(x => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.name}</td><td>${CLP(x.monthlyAmount)}</td><td>${x.notes || ''}</td>`;
        costRows.appendChild(tr);
      });
      opexRows.innerHTML = '';
      d.operatingExpenses.forEach(x => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.name}</td><td>${CLP(x.monthlyAmount)}</td><td>${x.notes || ''}</td>`;
        opexRows.appendChild(tr);
      });

      honRows.innerHTML = '';
      (d.honorarios || []).forEach(x => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.name}</td><td>${CLP(x.monthlyAmount)}</td><td>${x.notes || ''}</td>`;
        honRows.appendChild(tr);
      });

      bonusRows.innerHTML = '';
      (d.bonosExtraordinarios || []).forEach(x => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${x.beneficiary || ''}</td><td>${x.month || ''}</td><td>${CLP(x.amount || 0)}</td><td>${x.type || ''}</td><td>${x.notes || ''}</td>`;
        bonusRows.appendChild(tr);
      });

      projRows.innerHTML = '';
      (d.byProject || []).forEach(x => {
        const tr = document.createElement('tr');
        const contrib = (Number(x.net || 0) - Number(x.directCost || 0));
        tr.innerHTML = `<td>${x.project}</td><td>${CLP(x.net)}</td><td>${CLP(x.iva)}</td><td>${CLP(x.total)}</td><td>${CLP(x.directCost)}</td><td>${CLP(contrib)}</td>`;
        projRows.appendChild(tr);
      });
    }

    loginBtn.onclick = async () => {
      authMsg.textContent = 'Entrando...';
      const r = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u.value, password: p.value }) });
      if (!r.ok) { authMsg.textContent = 'Credenciales invÃ¡lidas'; return; }
      authMsg.textContent = 'OK';
      loadData();
    };
    loadData();
  </script>
</body>

</html>